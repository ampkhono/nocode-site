# 改変履歴 - 2025年11月14日

## 📝 概要
ノーコードゲームエディタの分岐機能を改善し、実際にゲームを実行できるプレビュー機能を実装しました。

---

## 🎯 1. 分岐機能の改善

### 改善内容

#### 選択肢ごとの分岐設定の強化
- 各選択肢から「次のノード」を選択するドロップダウンメニューを改善
- 現在編集中のノードを除外して、ループを防止
- ノードタイプ（質問/結果）をアイコンで視覚的に表示
- テキストの長さを制限して、見やすく改善

#### 分岐の可視化
- プレビューパネルで、各選択肢がどのノードに接続されているかを表示
- 接続あり/なしを色分けで視覚的に表示
- 接続先のノードタイプと内容を表示

### 変更ファイル
- `editor.js` - 分岐機能の改善
- `editor.html` - スタイルの追加

---

## 🎮 2. 実行可能プレビュー機能の実装

### 新機能

#### 実際にゲームを実行できるプレビュー
- 「👁️ プレビュー」ボタンをクリックすると、実際にゲームを実行できる新しいウィンドウが開く
- 質問に回答すると、設定した分岐に従って次の質問または結果に遷移
- 戻る機能により、前の質問に戻れる
- 最初からやり直し機能

#### プレビュー機能の詳細
1. **質問表示**
   - 質問文と選択肢ボタンを表示
   - 進捗（質問数）を表示

2. **分岐処理**
   - 選択肢をクリックすると、設定した `nextId` に従って次のノードに遷移
   - 質問ノードの場合は次の質問を表示
   - 結果ノードの場合は診断結果を表示

3. **結果表示**
   - 結果テキスト、画像、URLボタンを表示
   - 画像は `data/` フォルダから読み込み

4. **ナビゲーション**
   - 「← 戻る」ボタンで前の質問に戻れる
   - 「最初からやり直す」ボタンでスタートに戻る

### 実装詳細

```javascript
function selectChoice(nextId, choiceText) {
    // 質問ノードか結果ノードかを判定
    const question = gameData.questions.find(q => q.id === nextId);
    const result = gameData.results.find(r => r.id === nextId);
    
    if (question) {
        // 次の質問へ
        showQuestion(nextId);
    } else if (result) {
        // 結果を表示
        showResult(result);
    }
}
```

### 変更ファイル
- `editor.js` - `generatePreviewHTML()` 関数を完全に書き換え

---

## 🔧 3. UI/UX の改善

### プレビューパネルの改善
- 選択肢ごとの分岐情報をより詳細に表示
- 接続状況を色分けで視覚化
- 接続先ノードの内容を表示

### 選択肢エディタの改善
- ドロップダウンメニューの幅を調整
- 「なし」オプションを追加
- ノードタイプをアイコンで表示

### 変更ファイル
- `editor.html` - スタイル追加（`.choice-item select`, `.branch-visualization` など）
- `editor.js` - `getNextNodeOptions()` 関数の改善

---

## 📊 動作確認

### 分岐機能
- [x] 選択肢ごとに次のノードを設定可能
- [x] 質問→質問への分岐が正常に動作
- [x] 質問→結果への分岐が正常に動作
- [x] プレビューで分岐情報が正しく表示される

### プレビュー機能
- [x] プレビューウィンドウが正常に開く
- [x] 質問が正しく表示される
- [x] 選択肢をクリックすると次のノードに遷移
- [x] 分岐が正しく動作する
- [x] 戻る機能が動作する
- [x] 結果が正しく表示される
- [x] 画像の読み込みが機能する

---

## 💡 使用例

### 分岐設定の手順

1. **質問1を作成**
   - 「+ 質問を追加」をクリック
   - 質問文を入力（例: "あなたは何派？"）
   - 選択肢を追加（例: "外向型", "内向型"）

2. **質問2と質問3を作成**
   - それぞれ異なる質問を作成

3. **分岐を設定**
   - 質問1の選択肢1（外向型）の「次のノード」を質問2に設定
   - 質問1の選択肢2（内向型）の「次のノード」を質問3に設定

4. **結果を追加**
   - 質問2と質問3から、それぞれ異なる結果ノードに接続

5. **プレビューで確認**
   - 「👁️ プレビュー」をクリック
   - 実際にゲームを実行して分岐を確認

---

## 🔄 技術的な改善点

### 1. 分岐データ構造
```javascript
choices: [
    {
        text: "選択肢1",
        value: 0,
        nextId: "q_1"  // 次のノードID（質問または結果）
    }
]
```

### 2. ノード検索の最適化
- `gameData.questions.find()` と `gameData.results.find()` で効率的に検索
- 存在しない `nextId` の場合はエラーハンドリング

### 3. 履歴管理
- `history` 配列で遷移履歴を管理
- 戻る機能の実装

---

## 📝 備考

- 分岐が設定されていない選択肢をクリックすると、アラートが表示されます
- 画像ファイルは `data/` フォルダ内に配置する必要があります
- プレビューはブラウザのポップアップブロックを解除する必要がある場合があります

---

## 🐛 既知の制限事項

- CSVエクスポート時、複雑な分岐構造は完全に保持されない可能性があります
  - 現在のCSV形式は順番通りに出力するため、複雑な分岐には対応しきれない場合があります
  - 将来的には、分岐情報も含めたカスタムCSV形式を検討

---

## 🎨 4. デザイン設定機能の追加

### 新機能

#### フォント設定機能
- **質問文のフォント**: 質問文に適用するフォントを選択可能
  - 対応フォント: Arial、メイリオ、游ゴシック、MS ゴシック、Times New Roman
  - デフォルトフォントも選択可能
- **選択肢のフォント**: 選択肢ボタンに適用するフォントを選択可能
  - 質問文と同様のフォントから選択

#### カスタムCSS機能
- 質問の背景やスタイルを変更するためのカスタムCSSを追加可能
- `.container` クラスに対してスタイルを適用
- 上級者向け機能として、折りたたみセクションに配置

### 変更ファイル
- `editor.js` - 質問データ構造に `questionFont`, `choiceFont`, `customCSS` を追加
- `editor.js` - `showQuestionEditor()` 関数にフォント設定フィールドを追加
- `editor.js` - `generatePreviewHTML()` 関数でフォントスタイルを適用

---

## 🖼️ 5. GUIベースのデザイン設定機能

### 新機能

#### コード不要のデザイン設定
文系の方でも簡単にデザインを変更できるGUIベースの設定機能を実装しました。

#### 背景設定
1. **背景タイプの選択**
   - 単色: カラーピッカーで背景色を選択
   - 画像: 背景画像を選択（後述のカスタム画像も使用可能）
   - グラデーション: 2色のカラーピッカーでグラデーションを設定

2. **背景色設定**
   - カラーピッカーとテキスト入力の両方で設定可能
   - リアルタイムで同期

3. **背景画像設定**
   - デフォルト画像: 森、山、宇宙、星空の背景から選択
   - カスタム画像: ユーザーが追加した画像も選択可能（後述）

4. **グラデーション設定**
   - グラデーション色1と色2をカラーピッカーで設定
   - 135度のグラデーションを自動生成

#### 質問文のスタイル設定
1. **フォント選択**
   - ドロップダウンから選択（Arial、メイリオ、游ゴシックなど）
   - デフォルトフォントも選択可能

2. **フォントサイズ**
   - スライダーで調整（0.8em～2.5em）
   - リアルタイムでサイズを表示

3. **文字色**
   - カラーピッカーで設定
   - テキスト入力でも設定可能

#### 選択肢ボタンのスタイル設定
1. **フォント選択**
   - 質問文と同様のフォントから選択

2. **フォントサイズ**
   - スライダーで調整（0.8em～2.0em）

3. **ボタンの背景色**
   - カラーピッカーで設定

4. **ボタンの文字色**
   - カラーピッカーで設定

#### 自動CSS生成
- GUI設定から自動的にCSSを生成
- カスタムCSSと組み合わせて使用可能
- プレビューで即座に確認可能

### 実装詳細

```javascript
// 質問データ構造に追加されたフィールド
{
    backgroundType: 'color', // 'color', 'image', 'gradient'
    backgroundColor: '#ffffff',
    backgroundImage: '',
    gradientColor1: '#667eea',
    gradientColor2: '#764ba2',
    questionFontSize: '1.3em',
    questionTextColor: '#2d3748',
    choiceFontSize: '1.2em',
    choiceButtonColor: '#667eea',
    choiceButtonTextColor: '#ffffff'
}
```

### 変更ファイル
- `editor.js` - `addQuestion()` 関数でデフォルト値を設定
- `editor.js` - `showQuestionEditor()` 関数にGUI設定フォームを追加
- `editor.js` - `updateQuestionStyle()` 関数でCSSを自動生成
- `editor.js` - `generatePreviewHTML()` 関数でスタイルを適用

---

## 🖼️ 6. 背景画像プレビュー機能

### 新機能

#### エディタ内プレビュー
- 背景画像を選択すると、選択欄の下にプレビュー画像を表示
- 画像が読み込めない場合は自動的に非表示

#### 右側プレビュー画面
- 質問ノードを選択すると、設定済みの背景画像を表示
- 「背景画像:」ラベル付きで表示

### 変更ファイル
- `editor.js` - `showQuestionEditor()` 関数にプレビュー画像を追加
- `editor.js` - `updateBackgroundImagePreview()` 関数を追加
- `editor.js` - `showPreview()` 関数で背景画像を表示

---

## 📁 7. カスタム画像追加機能

### 新機能

#### 画像追加方法
1. **ファイル選択ボタン**
   - 「📂 ファイルを選択」ボタンをクリックして画像を選択
   - 複数の画像を同時に選択可能

2. **ドラッグ&ドロップ**
   - 画像をドロップゾーンにドラッグ&ドロップ
   - ドラッグ中は視覚的なフィードバックを表示

3. **クリックで選択**
   - ドロップゾーンをクリックしてファイルを選択

#### 画像の保存と管理
- **Base64エンコード**: 画像をBase64エンコードしてlocalStorageに保存
- **自動追加**: 追加した画像は背景画像の選択肢に自動追加
- **複数画像対応**: 複数の画像を追加可能
- **永続化**: ブラウザのlocalStorageに保存されるため、次回も利用可能

#### 対応形式
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)

#### プレビュー機能
- エディタ内プレビュー: 選択した画像を即座にプレビュー表示
- 右側プレビュー: 右側のプレビュー画面にも表示
- プレビューHTML: プレビューHTML生成時にも正しく表示（カスタム画像データを埋め込み）

### 実装詳細

```javascript
// カスタム画像の保存
function saveCustomImage(name, base64Data) {
    const customImages = JSON.parse(localStorage.getItem('customBackgroundImages') || '{}');
    customImages[name] = base64Data;
    localStorage.setItem('customBackgroundImages', JSON.stringify(customImages));
}

// カスタム画像の取得
function getCustomImageUrl(value) {
    if (value && value.startsWith('custom:')) {
        const name = value.substring(7);
        const customImages = JSON.parse(localStorage.getItem('customBackgroundImages') || '{}');
        return customImages[name] || '';
    }
    return value || '';
}
```

### 変更ファイル
- `editor.js` - カスタム画像管理関数を追加（`saveCustomImage()`, `getCustomImages()`, `getCustomImageUrl()` など）
- `editor.js` - `showQuestionEditor()` 関数に画像追加UIを追加
- `editor.js` - `handleImageFiles()`, `handleImageDrop()` 関数を追加
- `editor.js` - `updateBackgroundImageSelect()` 関数でカスタム画像を選択肢に追加
- `editor.js` - `generatePreviewHTML()` 関数でカスタム画像データを埋め込み

---

## 📊 動作確認（追加分）

### デザイン設定機能
- [x] フォント設定が正常に動作
- [x] カスタムCSSが正常に適用される
- [x] GUI設定からCSSが自動生成される
- [x] プレビューで設定が反映される

### 背景画像プレビュー
- [x] エディタ内で背景画像がプレビュー表示される
- [x] 右側プレビュー画面で背景画像が表示される
- [x] 画像が読み込めない場合のエラーハンドリングが動作

### カスタム画像追加
- [x] ファイル選択で画像を追加できる
- [x] ドラッグ&ドロップで画像を追加できる
- [x] 追加した画像が選択肢に表示される
- [x] 画像がlocalStorageに保存される
- [x] プレビューでカスタム画像が正しく表示される
- [x] プレビューHTMLでカスタム画像が正しく表示される

---

## 💡 使用例（追加分）

### デザイン設定の手順

1. **質問ノードを選択**
   - 左側のノード一覧から質問ノードをクリック

2. **デザイン設定を開く**
   - 「🎨 デザイン設定」セクションを確認

3. **背景を設定**
   - 「背景の種類」から「単色」「画像」「グラデーション」を選択
   - 選択した種類に応じて設定項目が表示される

4. **フォントを設定**
   - 「質問文のフォント」セクションでフォント、サイズ、色を設定
   - 「選択肢ボタンのフォント」セクションでボタンのスタイルを設定

5. **プレビューで確認**
   - 右側のプレビュー画面で設定を確認
   - 「👁️ プレビュー」ボタンで実際のゲーム画面を確認

### カスタム画像追加の手順

1. **画像追加セクションを開く**
   - 「背景の種類」を「画像」に設定
   - 「📁 画像を追加」セクションが表示される

2. **画像を追加**
   - 方法1: 「📂 ファイルを選択」ボタンをクリックして画像を選択
   - 方法2: 画像をドロップゾーンにドラッグ&ドロップ
   - 方法3: ドロップゾーンをクリックしてファイルを選択

3. **画像を選択**
   - 追加した画像は自動的に背景画像の選択肢に追加される
   - ドロップダウンから追加した画像を選択

4. **プレビューで確認**
   - エディタ内と右側のプレビュー画面で画像を確認

---

## 🔄 技術的な改善点（追加分）

### 1. データ構造の拡張
```javascript
// 質問ノードのデータ構造
{
    // ... 既存のフィールド ...
    questionFont: '',
    choiceFont: '',
    customCSS: '',
    backgroundType: 'color',
    backgroundColor: '#ffffff',
    backgroundImage: '',
    gradientColor1: '#667eea',
    gradientColor2: '#764ba2',
    questionFontSize: '1.3em',
    questionTextColor: '#2d3748',
    choiceFontSize: '1.2em',
    choiceButtonColor: '#667eea',
    choiceButtonTextColor: '#ffffff'
}
```

### 2. localStorageの活用
- カスタム画像をlocalStorageに保存
- ブラウザを閉じても画像が保持される
- プレビューHTML生成時にカスタム画像データを埋め込み

### 3. リアルタイムプレビュー
- 設定変更が即座にプレビューに反映
- カラーピッカーとテキスト入力の同期
- スライダーの値がリアルタイムで表示

### 4. エラーハンドリング
- 画像が読み込めない場合の処理
- ファイル形式の検証
- localStorageの容量制限への対応

---

## 📝 備考（追加分）

- カスタム画像はブラウザのlocalStorageに保存されます
  - ブラウザの容量制限（通常5-10MB）に注意してください
  - 大量の画像を追加する場合は、画像サイズを圧縮することを推奨します
- プレビューHTMLは別ウィンドウで開くため、カスタム画像データを埋め込んでいます
- GUI設定から生成されたCSSは、カスタムCSSと組み合わせて使用できます
- 背景画像のプレビューは、画像が読み込める場合のみ表示されます

---

**記録日**: 2025年11月14日  
**変更者**: AI Assistant  
**バージョン**: 1.2

